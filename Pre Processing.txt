/*================================*/
/* DATA PRE PROCESSING TECHNIQUES */
/*================================*/

/*-----------------------*/
/*DATA CLEANING*/
/*-----------------------*/
/*PART A : NOISY DATA & MISSING VALUES */
/*----------------------*/


PROC IMPORT OUT=heart.heart
    DATAFILE="/home/u64267019/sasuser.v94/Heart/heart_Disease.csv"
    DBMS=CSV
    REPLACE;
    GETNAMES=YES;
RUN;

/*Age*/
data heart_clean;
    set heart.heart;
    if Age = . then delete;
run;

proc means data=heart.heart mean std min max;
    var Age;
    title "Summary Statistics for Age";
run;

proc sgplot data=heart.heart;
    vbox Age;
    title "Box Plot of Age (Outlier Detection)";
run;


/* 1. Count rows BEFORE cleaning */
proc sql;
    create table before_clean as
    select "Before Cleaning" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing(Age)) as Missing_Age_Rows
    from heart.heart;
quit;

/* 2. Remove rows with missing Age */
data heart_clean;
    set heart.heart;
    if Age = . then delete;
run;

/* 3. Count rows AFTER cleaning */
proc sql;
    create table after_clean as
    select "After Cleaning" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing(Age)) as Missing_Age_Rows
    from heart_clean;
quit;

/* 4. Combine before & after into one comparison table */
data comparison;
    set before_clean after_clean;
run;

/* 5. Display the comparison table */
proc print data=comparison noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Age_Rows = "Rows with Missing Age";
run;

proc means data=heart.heart n nmiss;
    var Age;
run;

/*Gender*/
PROC sql;
	select count(*) as Missing_Gender_Count
	from heart.heart
	where Gender = '';
RUN;

proc freq data=heart.heart;
    tables Gender;
    title "Frequency Table for Gender";
run;

proc freq data=heart.heart;
    tables Gender / missing;
    title "Frequency Table for Gender";
run;

proc freq data=heart.heart nlevels;
    tables Gender;
run;

proc sgplot data=heart.heart;
    vbar Gender; /* vertical bar chart */
    title "Frequency of Gender";
run;

/* 1. Count rows BEFORE cleaning */
proc sql;
    create table before_clean as
    select "Before Cleaning" as Stage length=20,
           count(*) as Total_Rows,
           sum(case when Gender = '' then 1 else 0 end) as Missing_Gender_Rows
    from heart.heart;
quit;

/* 2. Remove rows with missing Gender */
data heart_clean;
    set heart.heart;
    if Gender = '' then delete;
run;

/* 3. Count rows AFTER cleaning */
proc sql;
    create table after_clean as
    select "After Cleaning" as Stage length=20,
           count(*) as Total_Rows,
           sum(case when Gender = '' then 1 else 0 end) as Missing_Gender_Rows
    from heart_clean;
quit;

/* 4. Combine before & after into one comparison table */
data comparison;
    set before_clean after_clean;
run;

/* 5. Display the comparison table */
proc print data=comparison noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Gender_Rows = "Rows with Missing Gender";
run;

/*Blood pressure*/
proc means data=heart.heart n nmiss;
    var 'Blood Pressure'n;
run;

proc univariate data=heart.heart;
  var 'Blood Pressure'n;
  ods select Moments;
run;

proc means data=heart.heart mean std min max;
    var 'Blood Pressure'n;
    title "Summary Statistics for Blood pressure";
run;

/* 1. Count missing BEFORE filling */
proc sql;
    create table before_fill as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Blood Pressure'n)) as Missing_BP_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Blood Pressure with mean */
data heart_filled;
    set heart.heart;
    if missing('Blood Pressure'n) then 'Blood Pressure'n = 150;
run;

/* 3. Count missing AFTER filling */
proc sql;
    create table after_fill as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Blood Pressure'n)) as Missing_BP_Rows
    from heart_filled;
quit;

/* 4. Combine for comparison */
data comparison;
    set before_fill after_fill;
run;

/* 5. Display the before/after table */
proc print data=comparison noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_BP_Rows = "Rows with Missing Blood Pressure";
run;

/*Cholesterol level*/
proc means data=heart.heart n nmiss;
    var 'Cholesterol level'n;
run;

proc univariate data=heart.heart;
  var 'Cholesterol level'n;
  ods select Moments;
run;

proc means data=heart.heart mean std min max;
    var 'Cholesterol level'n;
    title "Summary Statistics for Cholesterol level";
run;

/* 1. Count missing BEFORE filling */
proc sql;
    create table before_fill_chol as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Cholesterol Level'n)) as Missing_Chol_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Cholesterol Level with 225 */
data heart_filled_chol;
    set heart.heart;
    if missing('Cholesterol Level'n) then 'Cholesterol Level'n = 225;
run;

/* 3. Count missing AFTER filling */
proc sql;
    create table after_fill_chol as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Cholesterol Level'n)) as Missing_Chol_Rows
    from heart_filled_chol;
quit;

/* 4. Combine for comparison */
data comparison_chol;
    set before_fill_chol after_fill_chol;
run;

/* 5. Display the before/after table */
proc print data=comparison_chol noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Chol_Rows = "Rows with Missing Cholesterol Level";
run;

/*Exercise habits*/
proc freq data=heart.heart;
    tables 'Exercise habits'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'Exercise habits'n / missing;
    title "Frequency Table for Exercise habits";
run;

/* 1. Count missing BEFORE filling */
proc sql;
    create table before_fill_exercise as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Exercise habits'n)) as Missing_Exercise_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Exercise habits with "High" */
data heart_filled_exercise;
    set heart.heart;
    if missing('Exercise habits'n) then 'Exercise habits'n = "High";
run;

/* 3. Count missing AFTER filling */
proc sql;
    create table after_fill_exercise as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Exercise habits'n)) as Missing_Exercise_Rows
    from heart_filled_exercise;
quit;

/* 4. Combine before/after counts into one table */
data comparison_exercise;
    set before_fill_exercise after_fill_exercise;
run;

/* 5. Display before/after summary table */
proc print data=comparison_exercise noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Exercise_Rows = "Rows with Missing Exercise Habits";
run;

/*Smoking*/
proc freq data=heart.heart;
    tables Smoking / nocum nopercent;
run;

proc freq data=heart.heart;
    tables Smoking / missing;
    title "Frequency Table for Smoking";
run;

/* 1. Count missing BEFORE filling */
proc sql;
    create table before_fill_smoking as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing(Smoking)) as Missing_Smoking_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Smoking with "Yes" */
data heart_filled_smoking;
    set heart.heart;
    if missing(Smoking) then Smoking = "Yes";
run;

/* 3. Count missing AFTER filling */
proc sql;
    create table after_fill_smoking as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing(Smoking)) as Missing_Smoking_Rows
    from heart_filled_smoking;
quit;

/* 4. Combine before/after counts into one table */
data comparison_smoking;
    set before_fill_smoking after_fill_smoking;
run;

/* 5. Display before/after summary table */
proc print data=comparison_smoking noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Smoking_Rows = "Rows with Missing Smoking Status";
run;

/*Family heart disease*/
proc freq data=heart.heart;
    tables 'Family heart disease'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'Family heart disease'n / missing;
    title "Frequency Table for Family heart disease";
run;

/* 1. Count missing BEFORE filling */
proc sql;
    create table before_fill_family as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Family heart disease'n)) as Missing_Family_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Family_heart_disease with "No" (mode) */
data heart_filled_family;
    set heart.heart;
    if missing('Family heart disease'n) then 'Family heart disease'n = "No";
run;

/* 3. Count missing AFTER filling */
proc sql;
    create table after_fill_family as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Family heart disease'n)) as Missing_Family_Rows
    from heart_filled_family;
quit;

/* 4. Combine before/after counts into one table */
data comparison_family;
    set before_fill_family after_fill_family;
run;

/* 5. Display before/after summary table */
proc print data=comparison_family noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Family_Rows = "Rows with Missing Family Heart Disease Status";
run;

/*Diabetes*/
proc freq data=heart.heart;
    tables Diabetes / nocum nopercent;
run;

proc freq data=heart.heart;
    tables Diabetes / missing;
    title "Frequency Table for Diabetes";
run;

/* 1. Count missing BEFORE filling */
proc sql;
    create table before_fill_diabetes as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing(Diabetes)) as Missing_Diabetes_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Diabetes with "No" (mode) */
data heart_filled_diabetes;
    set heart.heart;
    if missing(Diabetes) then Diabetes = "No";
run;

/* 3. Count missing AFTER filling */
proc sql;
    create table after_fill_diabetes as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing(Diabetes)) as Missing_Diabetes_Rows
    from heart_filled_diabetes;
quit;

/* 4. Combine before/after counts into one table */
data comparison_diabetes;
    set before_fill_diabetes after_fill_diabetes;
run;

/* 5. Display before/after summary table */
proc print data=comparison_diabetes noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Diabetes_Rows = "Rows with Missing Diabetes Status";
run;

/*BMI*/
proc means data=heart.heart n nmiss;
    var BMI;
run;

proc univariate data=heart.heart;
  var BMI;
  ods select Moments;
run;

proc means data=heart.heart mean std min max;
    var BMI;
    title "Summary Statistics for BMI";
run;

/* 1. Count missing BEFORE filling */
proc sql;
    create table before_fill_BMI as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing(BMI)) as Missing_BMI_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing BMI with mean (29.0772689) */
data heart_filled_BMI;
    set heart.heart;
    if missing(BMI) then BMI = 29.0772689;
run;

/* 3. Count missing AFTER filling */
proc sql;
    create table after_fill_BMI as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing(BMI)) as Missing_BMI_Rows
    from heart_filled_BMI;
quit;

/* 4. Combine before/after counts into one table */
data comparison_BMI;
    set before_fill_BMI after_fill_BMI;
run;

/* 5. Display before/after summary table */
proc print data=comparison_BMI noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_BMI_Rows = "Rows with Missing BMI";
run;

/*High Blood pressure*/
proc freq data=heart.heart;
    tables 'High Blood pressure'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'High Blood pressure'n / missing;
    title "Frequency Table for High Blood pressure";
run;

/* 1. Count missing BEFORE filling for High Blood Pressure */
proc sql;
    create table before_fill_hbp as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('High Blood Pressure'n)) as Missing_HBP_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing High Blood Pressure with "Yes" */
data heart_filled_hbp;
    set heart.heart;
    if missing('High Blood Pressure'n) then 'High Blood Pressure'n = "Yes";
run;

/* 3. Count missing AFTER filling for High Blood Pressure */
proc sql;
    create table after_fill_hbp as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('High Blood Pressure'n)) as Missing_HBP_Rows
    from heart_filled_hbp;
quit;

/* 4. Combine before/after counts into one table */
data comparison_hbp;
    set before_fill_hbp after_fill_hbp;
run;

/* 5. Display before/after summary table */
proc print data=comparison_hbp noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_HBP_Rows = "Rows with Missing High Blood Pressure";
run;


/*Low HDL cholesterol*/
proc freq data=heart.heart;
    tables 'Low HDL cholesterol'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'Low HDL cholesterol'n / missing;
    title "Frequency Table for Low HDL cholesterol";
run;

/* 1. Count missing BEFORE filling for Low HDL Cholesterol */
proc sql;
    create table before_fill_hdl as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Low HDL cholesterol'n)) as Missing_HDL_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Low HDL Cholesterol with "Yes" */
data heart_filled_hdl;
    set heart.heart;
    if missing('Low HDL cholesterol'n) then 'Low HDL cholesterol'n = "Yes";
run;

/* 3. Count missing AFTER filling for Low HDL Cholesterol */
proc sql;
    create table after_fill_hdl as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Low HDL cholesterol'n)) as Missing_HDL_Rows
    from heart_filled_hdl;
quit;

/* 4. Combine before/after counts into one table */
data comparison_hdl;
    set before_fill_hdl after_fill_hdl;
run;

/* 5. Display before/after summary table */
proc print data=comparison_hdl noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_HDL_Rows = "Rows with Missing Low HDL Cholesterol";
run;

/*High LDL cholesterol*/
proc freq data=heart.heart;
    tables 'High LDL cholesterol'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'High LDL cholesterol'n / missing;
    title "Frequency Table for High LDL cholesterol";
run;

/* 1. Count missing BEFORE filling for High LDL Cholesterol */
proc sql;
    create table before_fill_ldl as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('High LDL cholesterol'n)) as Missing_LDL_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing High LDL Cholesterol with "No" */
data heart_filled_ldl;
    set heart.heart;
    if missing('High LDL cholesterol'n) then 'High LDL cholesterol'n = "No";
run;

/* 3. Count missing AFTER filling for High LDL Cholesterol */
proc sql;
    create table after_fill_ldl as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('High LDL cholesterol'n)) as Missing_LDL_Rows
    from heart_filled_ldl;
quit;

/* 4. Combine before/after counts into one table */
data comparison_ldl;
    set before_fill_ldl after_fill_ldl;
run;

/* 5. Display before/after summary table */
proc print data=comparison_ldl noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_LDL_Rows = "Rows with Missing High LDL Cholesterol";
run;

/*Alcohol consumption*/
proc freq data=heart.heart;
    tables 'Alcohol consumption'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'Alcohol consumption'n / missing;
    title "Frequency Table for Alcohol consumption";
run;

/* 1. Count missing BEFORE filling for Alcohol Consumption */
proc sql;
    create table before_fill_alcohol as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Alcohol consumption'n)) as Missing_Alcohol_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Alcohol Consumption with "None" */
data heart_filled_alcohol;
    set heart.heart;
    if missing('Alcohol consumption'n) then 'Alcohol consumption'n = "None";
run;

/* 3. Count missing AFTER filling for Alcohol Consumption */
proc sql;
    create table after_fill_alcohol as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Alcohol consumption'n)) as Missing_Alcohol_Rows
    from heart_filled_alcohol;
quit;

/* 4. Combine before/after counts into one table */
data comparison_alcohol;
    set before_fill_alcohol after_fill_alcohol;
run;

/* 5. Display before/after summary table */
proc print data=comparison_alcohol noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Alcohol_Rows = "Rows with Missing Alcohol Consumption";
run;

/*Stress level*/
proc freq data=heart.heart;
    tables 'Stress level'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'Stress level'n / missing;
    title "Frequency Table for Stress level";
run;

/* 1. Count missing BEFORE filling for Stress Level */
proc sql;
    create table before_fill_stress as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Stress level'n)) as Missing_Stress_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Stress Level with "Medium" */
data heart_filled_stress;
    set heart.heart;
    if missing('Stress level'n) then 'Stress level'n = "Medium";
run;

/* 3. Count missing AFTER filling for Stress Level */
proc sql;
    create table after_fill_stress as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Stress level'n)) as Missing_Stress_Rows
    from heart_filled_stress;
quit;

/* 4. Combine before/after counts into one table */
data comparison_stress;
    set before_fill_stress after_fill_stress;
run;

/* 5. Display before/after summary table */
proc print data=comparison_stress noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Stress_Rows = "Rows with Missing Stress Level";
run;

/*Sleep hours*/
proc means data=heart.heart n nmiss;
    var 'Sleep hours'n;
run;

proc univariate data=heart.heart;
  var 'Sleep hours'n;
  ods select Moments;
run;

proc means data=heart.heart mean std min max;
    var 'Sleep hours'n;
    title "Summary Statistics for Sleep hours";
run;

/* 1. Count missing BEFORE filling for Sleep Hours */
proc sql;
    create table before_fill_sleep as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Sleep hours'n)) as Missing_Sleep_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Sleep Hours with mean (6.99132945) */
data heart_filled_sleep;
    set heart.heart;
    if missing('Sleep hours'n) then 'Sleep hours'n = 6.99132945;
run;

/* 3. Count missing AFTER filling for Sleep Hours */
proc sql;
    create table after_fill_sleep as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Sleep hours'n)) as Missing_Sleep_Rows
    from heart_filled_sleep;
quit;

/* 4. Combine before/after counts into one table */
data comparison_sleep;
    set before_fill_sleep after_fill_sleep;
run;

/* 5. Display before/after summary table */
proc print data=comparison_sleep noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Sleep_Rows = "Rows with Missing Sleep Hours";
run;

/*Sugar consumption*/
proc freq data=heart.heart;
    tables 'Sugar consumption'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'Sugar consumption'n / missing;
    title "Frequency Table for Sugar consumption";
run;

/* 1. Count missing BEFORE filling for Sugar Consumption */
proc sql;
    create table before_fill_sugar as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Sugar consumption'n)) as Missing_Sugar_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Sugar Consumption with "Low" */
data heart_filled_sugar;
    set heart.heart;
    if missing('Sugar consumption'n) then 'Sugar consumption'n = "Low";
run;

/* 3. Count missing AFTER filling for Sugar Consumption */
proc sql;
    create table after_fill_sugar as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Sugar consumption'n)) as Missing_Sugar_Rows
    from heart_filled_sugar;
quit;

/* 4. Combine before/after counts into one table */
data comparison_sugar;
    set before_fill_sugar after_fill_sugar;
run;

/* 5. Display before/after summary table */
proc print data=comparison_sugar noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Sugar_Rows = "Rows with Missing Sugar Consumption";
run;

/*Triglyceride level*/
proc means data=heart.heart n nmiss;
    var 'Triglyceride level'n;
run;

proc univariate data=heart.heart;
  var 'Triglyceride level'n;
  ods select Moments;
run;

proc means data=heart.heart mean std min max;
    var 'Triglyceride level'n;
    title "Summary Statistics for Triglyceride level";
run;

/* 1. Count missing BEFORE filling for Triglyceride Level */
proc sql;
    create table before_fill_trig as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Triglyceride Level'n)) as Missing_Trig_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Triglyceride Level with mean (251) */
data heart_filled_trig;
    set heart.heart;
    if missing('Triglyceride Level'n) then 'Triglyceride Level'n = 251;
run;

/* 3. Count missing AFTER filling for Triglyceride Level */
proc sql;
    create table after_fill_trig as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Triglyceride Level'n)) as Missing_Trig_Rows
    from heart_filled_trig;
quit;

/* 4. Combine before/after counts into one table */
data comparison_trig;
    set before_fill_trig after_fill_trig;
run;

/* 5. Display before/after summary table */
proc print data=comparison_trig noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_Trig_Rows = "Rows with Missing Triglyceride Level";
run;

/*Fasting Blood Sugar*/
proc means data=heart.heart n nmiss;
    var 'Fasting Blood Sugar'n;
run;

proc univariate data=heart.heart;
  var 'Fasting Blood Sugar'n;
  ods select Moments;
run;

proc means data=heart.heart mean std min max;
    var 'Fasting Blood Sugar'n;
    title "Summary Statistics for Fasting Blood Sugar";
run;

/* 1. Count missing BEFORE filling for Fasting Blood Sugar */
proc sql;
    create table before_fill_fbs as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Fasting Blood Sugar'n)) as Missing_FBS_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Fasting Blood Sugar with mean (120) */
data heart_filled_fbs;
    set heart.heart;
    if missing('Fasting Blood Sugar'n) then 'Fasting Blood Sugar'n = 120;
run;

/* 3. Count missing AFTER filling for Fasting Blood Sugar */
proc sql;
    create table after_fill_fbs as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Fasting Blood Sugar'n)) as Missing_FBS_Rows
    from heart_filled_fbs;
quit;

/* 4. Combine before/after counts into one table */
data comparison_fbs;
    set before_fill_fbs after_fill_fbs;
run;

/* 5. Display before/after summary table */
proc print data=comparison_fbs noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_FBS_Rows = "Rows with Missing Fasting Blood Sugar";
run;

/*CRP level*/
proc means data=heart.heart n nmiss;
    var 'CRP level'n;
run;

proc univariate data=heart.heart;
  var 'CRP level'n;
  ods select Moments;
run;

proc means data=heart.heart mean std min max;
    var 'CRP level'n;
    title "Summary Statistics for CRP level";
run;

/* 1. Count missing BEFORE filling for CRP Level */
proc sql;
    create table before_fill_crp as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('CRP Level'n)) as Missing_CRP_Rows
    from heart.heart;
quit;

/* 2. Calculate median for CRP Level */
proc means data=heart.heart median noprint;
    var 'CRP Level'n;
    output out=median_crp median=median_crp;
run;

/* 3. Create a new dataset and fill missing CRP Level with median */
data heart_filled_crp;
    if _N_ = 1 then set median_crp; /* bring median value into data step */
    set heart.heart;
    if missing('CRP Level'n) then 'CRP Level'n = median_crp;
run;

/* 4. Count missing AFTER filling for CRP Level */
proc sql;
    create table after_fill_crp as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('CRP Level'n)) as Missing_CRP_Rows
    from heart_filled_crp;
quit;

/* 5. Combine before/after counts into one table */
data comparison_crp;
    set before_fill_crp after_fill_crp;
run;

/* 6. Display before/after summary table */
proc print data=comparison_crp noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_CRP_Rows = "Rows with Missing CRP Level";
run;

/*Homocysteine level*/
proc means data=heart.heart n nmiss;
    var 'Homocysteine level'n;
run;

proc univariate data=heart.heart;
  var 'Homocysteine level'n;
  ods select Moments;
run;

proc means data=heart.heart mean std min max;
    var 'Homocysteine level'n;
    title "Summary Statistics for Homocysteine level";
run;

/* 1. Count missing BEFORE filling for Homocysteine Level */
proc sql;
    create table before_fill_hcy as
    select "Before Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Homocysteine Level'n)) as Missing_HCY_Rows
    from heart.heart;
quit;

/* 2. Create a new dataset and fill missing Homocysteine Level with mean (12.4562709) */
data heart_filled_hcy;
    set heart.heart;
    if missing('Homocysteine Level'n) then 'Homocysteine Level'n = 12.4562709;
run;

/* 3. Count missing AFTER filling for Homocysteine Level */
proc sql;
    create table after_fill_hcy as
    select "After Filling" as Stage length=20,
           count(*) as Total_Rows,
           sum(missing('Homocysteine Level'n)) as Missing_HCY_Rows
    from heart_filled_hcy;
quit;

/* 4. Combine before/after counts into one table */
data comparison_hcy;
    set before_fill_hcy after_fill_hcy;
run;

/* 5. Display before/after summary table */
proc print data=comparison_hcy noobs label;
    label Stage = "Dataset Stage"
          Total_Rows = "Number of Rows"
          Missing_HCY_Rows = "Rows with Missing Homocysteine Level";
run;

/*Heart disease status*/
proc freq data=heart.heart;
    tables 'Heart disease status'n / nocum nopercent;
run;

proc freq data=heart.heart;
    tables 'Heart disease status'n / missing;
    title "Frequency Table for Heart disease status";
run;

/*===============*/
/* DATA CLEANING */
/*===============*/

/*-----------------------*/
/*PART B : OUTLIERS & INCONSISTENCIES */
/*----------------------*/


/*=====================================================*/
/* 1. Generate Boxplots for Numeric Variables          */
/*=====================================================*/
proc sgplot data=LAB.HEART_DISEASE;
    vbox age;
    title "Boxplot of Age - Before Cleaning";
run;

proc sgplot data=LAB.HEART_DISEASE;
    vbox 'Blood Pressure'n;
    title "Boxplot of Blood Pressure - Before Cleaning";
run;

proc sgplot data=LAB.HEART_DISEASE;
    vbox 'Cholesterol Level'n;
    title "Boxplot of Cholesterol Level - Before Cleaning";
run;

proc sgplot data=LAB.HEART_DISEASE;
    vbox BMI;
    title "Boxplot of BMI - Before Cleaning";
run;

proc sgplot data=LAB.HEART_DISEASE;
    vbox 'Triglyceride Level'n;
    title "Boxplot of Triglyceride Level - Before Cleaning";
run;

proc sgplot data=LAB.HEART_DISEASE;
    vbox 'Fasting Blood Sugar'n;
    title "Boxplot of Fasting Blood Sugar - Before Cleaning";
run;

proc sgplot data=LAB.HEART_DISEASE;
    vbox 'CRP Level'n;
    title "Boxplot of CRP Level  - Before Cleaning";
run;

proc sgplot data=LAB.HEART_DISEASE;
    vbox 'Homocysteine Level'n;
    title "Boxplot of Homocysteine Level  - Before Cleaning";
run;

proc sgplot data=LAB.HEART_DISEASE;
    vbox 'Sleep Hours'n;
    title "Boxplot of Sleep Hours  - Before Cleaning";
run;


/*=====================================================*/
/* 2. Calculate IQR (Q1 & Q3) for Each Variable        */
/*=====================================================*/
proc means data=LAB.HEART_DISEASE noprint;
    var age 'Blood Pressure'n 'Cholesterol Level'n bmi
        'Triglyceride Level'n 'Fasting Blood Sugar'n
        'CRP Level'n 'Homocysteine Level'n 'Sleep Hours'n;
    output out=stats
        p25=age_Q1 bp_Q1 chol_Q1 bmi_Q1 tri_Q1 fbs_Q1 crp_Q1 homo_Q1 sleep_Q1
        p75=age_Q3 bp_Q3 chol_Q3 bmi_Q3 tri_Q3 fbs_Q3 crp_Q3 homo_Q3 sleep_Q3;
run;

/*=====================================================*/
/* 3. Assign Macro Variables for Each Variable Cutoff  */
/*=====================================================*/
data _null_;
    set stats;

    /* Each variable uses its OWN Q1/Q3, not a combined one */
    call symputx('age_low', age_Q1 - 1.0*(age_Q3 - age_Q1));
    call symputx('age_high', age_Q3 + 1.0*(age_Q3 - age_Q1));

    call symputx('bp_low', bp_Q1 - 1.0*(bp_Q3 - bp_Q1));
    call symputx('bp_high', bp_Q3 + 1.0*(bp_Q3 - bp_Q1));

    call symputx('chol_low', chol_Q1 - 1.0*(chol_Q3 - chol_Q1));
    call symputx('chol_high', chol_Q3 + 1.0*(chol_Q3 - chol_Q1));

    call symputx('bmi_low', bmi_Q1 - 1.0*(bmi_Q3 - bmi_Q1));
    call symputx('bmi_high', bmi_Q3 + 1.0*(bmi_Q3 - bmi_Q1));

    call symputx('tri_low', tri_Q1 - 1.0*(tri_Q3 - tri_Q1));
    call symputx('tri_high', tri_Q3 + 1.0*(tri_Q3 - tri_Q1));

    call symputx('fbs_low', fbs_Q1 - 1.0*(fbs_Q3 - fbs_Q1));
    call symputx('fbs_high', fbs_Q3 + 1.0*(fbs_Q3 - fbs_Q1));

    call symputx('crp_low', crp_Q1 - 1.0*(crp_Q3 - crp_Q1));
    call symputx('crp_high', crp_Q3 + 1.0*(crp_Q3 - crp_Q1));

    call symputx('homo_low', homo_Q1 - 1.0*(homo_Q3 - homo_Q1));
    call symputx('homo_high', homo_Q3 + 1.0*(homo_Q3 - homo_Q1));

    call symputx('sleep_low', sleep_Q1 - 1.0*(sleep_Q3 - sleep_Q1));
    call symputx('sleep_high', sleep_Q3 + 1.0*(sleep_Q3 - sleep_Q1));
run;


/*=====================================================*/
/* 4. Winsorize (Cap) Outliers + Apply Medical Cutoffs */
/*=====================================================*/
data LAB.HEART_CLEAN_Final;
    set LAB.HEART_DISEASE;

    /* Winsorization using stricter IQR cutoffs */
    if age < &age_low then age = &age_low;
    else if age > &age_high then age = &age_high;

    if 'Blood Pressure'n < &bp_low then 'Blood Pressure'n = &bp_low;
    else if 'Blood Pressure'n > &bp_high then 'Blood Pressure'n = &bp_high;

    if 'Cholesterol Level'n < &chol_low then 'Cholesterol Level'n = &chol_low;
    else if 'Cholesterol Level'n > &chol_high then 'Cholesterol Level'n = &chol_high;

    if bmi < &bmi_low then bmi = &bmi_low;
    else if bmi > &bmi_high then bmi = &bmi_high;

    if 'Triglyceride Level'n < &tri_low then 'Triglyceride Level'n = &tri_low;
    else if 'Triglyceride Level'n > &tri_high then 'Triglyceride Level'n = &tri_high;

    if 'Fasting Blood Sugar'n < &fbs_low then 'Fasting Blood Sugar'n = &fbs_low;
    else if 'Fasting Blood Sugar'n > &fbs_high then 'Fasting Blood Sugar'n = &fbs_high;

    if 'CRP Level'n < &crp_low then 'CRP Level'n = &crp_low;
    else if 'CRP Level'n > &crp_high then 'CRP Level'n = &crp_high;

    if 'Homocysteine Level'n < &homo_low then 'Homocysteine Level'n = &homo_low;
    else if 'Homocysteine Level'n > &homo_high then 'Homocysteine Level'n = &homo_high;

    if 'Sleep Hours'n < &sleep_low then 'Sleep Hours'n = &sleep_low;
    else if 'Sleep Hours'n > &sleep_high then 'Sleep Hours'n = &sleep_high;

    /* Extra Medical Cutoffs for Clinical Validity */
    if age > 120 then age = 120;
    if 'Blood Pressure'n > 250 then 'Blood Pressure'n = 250;
    if 'Cholesterol Level'n > 500 then 'Cholesterol Level'n = 500;
    if bmi > 60 then bmi = 60;
    if 'Sleep Hours'n > 20 then 'Sleep Hours'n = 20;
run;


/*=====================================================*/
/* 5. Verify After Cleaning                            */
/*=====================================================*/
proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox age;
    title "Boxplot of Age - After Cleaning";
run;

proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox 'Blood Pressure'n;
    title "Boxplot of Blood Pressure - After Cleaning";
run;

proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox 'Cholesterol Level'n;
    title "Boxplot of Cholesterol Level - After Cleaning";
run;

proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox BMI;
    title "Boxplot of BMI - After Cleaning";
run;

proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox 'Triglyceride Level'n;
    title "Boxplot of Triglyceride Level - After Cleaning";
run;

proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox 'Fasting Blood Sugar'n;
    title "Boxplot of Fasting Blood Sugar - After Cleaning";
run;

proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox 'CRP Level'n;
    title "Boxplot of CRP Level  - After Cleaning";
run;

proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox 'Homocysteine Level'n;
    title "Boxplot of Homocysteine Level  - After Cleaning";
run;

proc sgplot data=LAB.HEART_CLEAN_FINAL;
    vbox 'Sleep Hours'n;
    title "Boxplot of Sleep Hours  - After Cleaning";
run;


/*=====================================================*/
/* 6. Summary                                          */
/*=====================================================*/

/* Summary Before Cleaning */
proc means data=LAB.HEART_DISEASE n min max mean std;
    var age 'Blood Pressure'n 'Cholesterol Level'n bmi
        'Triglyceride Level'n 'Fasting Blood Sugar'n
        'CRP Level'n 'Homocysteine Level'n 'Sleep Hours'n;
    title "Summary Statistics - Before Cleaning";
run;

/* Summary After Cleaning */
proc means data=LAB.HEART_CLEAN_FINAL n min max mean std;
    var age 'Blood Pressure'n 'Cholesterol Level'n bmi
        'Triglyceride Level'n 'Fasting Blood Sugar'n
        'CRP Level'n 'Homocysteine Level'n 'Sleep Hours'n;
    title "Summary Statistics - After Cleaning";
run;




/*=====================================================*/
/* 1. Frequency Tables - Identify Inconsistencies      */
/*=====================================================*/
proc freq data=LAB.HEART_DISEASE;
    tables Gender 'Exercise Habits'n Smoking 
           'Family Heart Disease'n Diabetes 
           'High Blood Pressure'n 'Low HDL Cholesterol'n
           'High LDL Cholesterol'n 'Alcohol Consumption'n
           'Heart Disease Status'n 'Stress Level'n
           'Sugar Consumption'n / nocum nopercent;
    title "Frequency Tables for Categorical Attributes - Before Cleaning";
run;

/*=====================================================*/
/* 2. Data Cleaning for Inconsistencies                */
/*=====================================================*/
data LAB.HEART_CLEAN_FINAL;
    set LAB.HEART_DISEASE;

    /* --- Standardize text: trim spaces & convert to uppercase --- */
    Gender                 = upcase(strip(Gender));
    'Exercise Habits'n     = upcase(strip('Exercise Habits'n));
    Smoking                = upcase(strip(Smoking));
    'Family Heart Disease'n= upcase(strip('Family Heart Disease'n));
    Diabetes               = upcase(strip(Diabetes));
    'High Blood Pressure'n = upcase(strip('High Blood Pressure'n));
    'Low HDL Cholesterol'n = upcase(strip('Low HDL Cholesterol'n));
    'High LDL Cholesterol'n= upcase(strip('High LDL Cholesterol'n));
    'Alcohol Consumption'n = upcase(strip('Alcohol Consumption'n));
    'Heart Disease Status'n= upcase(strip('Heart Disease Status'n));
    'Stress Level'n        = upcase(strip('Stress Level'n));
    'Sugar Consumption'n   = upcase(strip('Sugar Consumption'n));

    /* --- Recode values to standard categories --- */

    /* Gender */
    if Gender in ("M","MALE") then Gender="MALE";
    else if Gender in ("F","FEMALE") then Gender="FEMALE";
    else if Gender not in ("MALE","FEMALE") then Gender="UNKNOWN";

    /* Exercise Habits */
    if 'Exercise Habits'n in ("Y","YES") then 'Exercise Habits'n="YES";
    else if 'Exercise Habits'n in ("N","NO") then 'Exercise Habits'n="NO";
    else if 'Exercise Habits'n not in ("YES","NO") then 'Exercise Habits'n="UNKNOWN";

    /* Smoking */
    if Smoking in ("Y","YES") then Smoking="YES";
    else if Smoking in ("N","NO") then Smoking="NO";
    else if Smoking not in ("YES","NO") then Smoking="UNKNOWN";

    /* Family Heart Disease */
    if 'Family Heart Disease'n in ("Y","YES") then 'Family Heart Disease'n="YES";
    else if 'Family Heart Disease'n in ("N","NO") then 'Family Heart Disease'n="NO";
    else if 'Family Heart Disease'n not in ("YES","NO") then 'Family Heart Disease'n="UNKNOWN";

    /* Diabetes */
    if Diabetes in ("Y","YES") then Diabetes="YES";
    else if Diabetes in ("N","NO") then Diabetes="NO";
    else if Diabetes not in ("YES","NO") then Diabetes="UNKNOWN";

    /* High Blood Pressure */
    if 'High Blood Pressure'n in ("Y","YES") then 'High Blood Pressure'n="YES";
    else if 'High Blood Pressure'n in ("N","NO") then 'High Blood Pressure'n="NO";
    else if 'High Blood Pressure'n not in ("YES","NO") then 'High Blood Pressure'n="UNKNOWN";

    /* Low HDL Cholesterol */
    if 'Low HDL Cholesterol'n in ("Y","YES") then 'Low HDL Cholesterol'n="YES";
    else if 'Low HDL Cholesterol'n in ("N","NO") then 'Low HDL Cholesterol'n="NO";
    else if 'Low HDL Cholesterol'n not in ("YES","NO") then 'Low HDL Cholesterol'n="UNKNOWN";

    /* High LDL Cholesterol */
    if 'High LDL Cholesterol'n in ("Y","YES") then 'High LDL Cholesterol'n="YES";
    else if 'High LDL Cholesterol'n in ("N","NO") then 'High LDL Cholesterol'n="NO";
    else if 'High LDL Cholesterol'n not in ("YES","NO") then 'High LDL Cholesterol'n="UNKNOWN";

    /* Alcohol Consumption */
    if 'Alcohol Consumption'n in ("Y","YES") then 'Alcohol Consumption'n="YES";
    else if 'Alcohol Consumption'n in ("N","NO") then 'Alcohol Consumption'n="NO";
    else if 'Alcohol Consumption'n not in ("YES","NO") then 'Alcohol Consumption'n="UNKNOWN";

    /* Heart Disease Status */
    if 'Heart Disease Status'n in ("Y","YES","POSITIVE") then 'Heart Disease Status'n="YES";
    else if 'Heart Disease Status'n in ("N","NO","NEGATIVE") then 'Heart Disease Status'n="NO";
    else if 'Heart Disease Status'n not in ("YES","NO") then 'Heart Disease Status'n="UNKNOWN";

    /* Stress Level */
    if 'Stress Level'n in ("LOW","L") then 'Stress Level'n="LOW";
    else if 'Stress Level'n in ("MEDIUM","M") then 'Stress Level'n="MEDIUM";
    else if 'Stress Level'n in ("HIGH","H") then 'Stress Level'n="HIGH";
    else if 'Stress Level'n not in ("LOW","MEDIUM","HIGH") then 'Stress Level'n="UNKNOWN";

    /* Sugar Consumption */
    if 'Sugar Consumption'n in ("LOW","L") then 'Sugar Consumption'n="LOW";
    else if 'Sugar Consumption'n in ("MEDIUM","M") then 'Sugar Consumption'n="MEDIUM";
    else if 'Sugar Consumption'n in ("HIGH","H") then 'Sugar Consumption'n="HIGH";
    else if 'Sugar Consumption'n not in ("LOW","MEDIUM","HIGH") then 'Sugar Consumption'n="UNKNOWN";
run;

/*=====================================================*/
/* 3. Verify Cleaning                                  */
/*=====================================================*/
proc freq data=LAB.HEART_CLEAN_FINAL;
    tables Gender 'Exercise Habits'n Smoking 
           'Family Heart Disease'n Diabetes 
           'High Blood Pressure'n 'Low HDL Cholesterol'n
           'High LDL Cholesterol'n 'Alcohol Consumption'n
           'Heart Disease Status'n 'Stress Level'n
           'Sugar Consumption'n / nocum nopercent;
    title "Frequency Tables for Categorical Attributes - After Cleaning";
run;

/*======================*/
/* DATA TRANSFORMATION */
/*======================*/


/* STEP 1: Import cleaned dataset */
PROC IMPORT OUT=heart_final
    DATAFILE="/home/u64267319/Assignment/HEART_FINAL.csv"
    DBMS=CSV
    REPLACE;
    GETNAMES=YES;
RUN;

/* STEP 2: Transformations - create heart_transformed */
DATA heart_transformed;
    SET heart_final;

    /* Age Binning */
    LENGTH Age_Group $12;
    IF Age < 30 THEN Age_Group = "Young";
    ELSE IF 30 <= Age < 45 THEN Age_Group = "Middle";
    ELSE IF 45 <= Age < 60 THEN Age_Group = "Senior";
    ELSE IF Age >= 60 THEN Age_Group = "Elderly";

    /* Binary encoding */
    Smoking_bin = (Smoking="Yes");
    Diabetes_bin = (Diabetes="Yes");
    Alcohol_bin = (Alcohol="Yes");
    Family_History_bin = (Family_History="Yes");
    High_BP_bin = (High_Blood_Pressure="Yes");
    Low_HDL_bin = (Low_HDL_Cholesterol="Yes");
    High_LDL_bin = (High_LDL_Cholesterol="Yes");

    /* Risk Score */
    Risk_Score = sum(Smoking_bin, Diabetes_bin, Alcohol_bin,
                     Family_History_bin, High_BP_bin,
                     Low_HDL_bin, High_LDL_bin);

    /* Log Transformations */
    Log_Cholesterol   = LOG(Cholesterol);
    Log_Triglyceride  = LOG(Triglyceride);
    Log_Homocysteine  = LOG(Homocysteine);

    /* Drop unnecessary variable */
    DROP median_crp;
RUN;

/* STEP 3: Standardize Age and BMI into Age_z and BMI_z */
PROC STANDARD DATA=heart_transformed MEAN=0 STD=1 OUT=heart_transformed;
    VAR Age BMI;
RUN;

DATA heart_transformed;
    SET heart_transformed;
    Age_z = Age;  /* standardized */
    BMI_z = BMI;  /* standardized */
RUN;

/* STEP 4: Validation */
PROC CONTENTS DATA=heart_transformed; RUN;
PROC MEANS DATA=heart_transformed N MEAN STD; RUN;

/*======================*/
/* DATA REDUCTION */
/*======================*/

proc print data=Lab1.heart_clean_final;
run;

* Data Reduction;
* It keeps the variables start from age until sugar consumption. Unuse variable is been removed;
data heart_reduction;
set work.import_raw;
drop 'Triglyceride Level'n 'Fasting Blood Sugar'n 'CRP Level'n 'Homocysteine Level'n 'Heart Disease Status'n;
run;

* It remove the unknow value from stress level;
data heart_reduction;
set Lab1.heart_clean_final;
where 'Stress Level'n ne "UNKNOW";
run;

* Grouping Stress Level into low level and high level;
proc sgplot data=heart_reduction;
vbar 'Stress Level'n;
title "Before grouping Stress Levels (Low, Medium, High)";
run;

data heart_reduction;
set heart_reduction;
if 'Stress Level'n = "LOW" then StressGroup = "Low Stress";
else StressGroup = "High Stress";
run;

proc sgplot data=heart_reduction;
vbar StressGroup;
title "After grouping Stress Levels (Low vs High)";
run;












